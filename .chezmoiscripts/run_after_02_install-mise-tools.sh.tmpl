#!{{ lookPath "sh" }}

{{ if eq .chezmoi.os "darwin" -}}

# Colores para output
if [ -t 1 ] && [ -n "$TERM" ] && [ "$TERM" != "dumb" ]; then
    BLUE='\033[0;34m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    BLUE=''
    GREEN=''
    YELLOW=''
    NC=''
fi

if ! command -v mise >/dev/null 2>&1; then
  printf "%b\n" "${YELLOW}⚠ mise no está instalado, omitiendo instalación de herramientas${NC}"
  exit 0
fi

CONFIG_FILE="${HOME}/.config/mise/config.toml"

if [ -f "$CONFIG_FILE" ]; then
    printf "%b\n" "${BLUE}Instalando herramientas de mise...${NC}"
    
    # Verificar que Nix está disponible (dependencia previa)
    if ! command -v nix >/dev/null 2>&1; then
        printf "%b\n" "${YELLOW}⚠ Nix no disponible aún. Saltando Mise.${NC}"
        exit 0
    fi

    # Instalar herramientas, ignorando errores individuales
    mise install 2>&1 | grep -v "^WARNING\|^ERROR" | tail -5 || true
    
    # Re-generar shims
    mise reshim 2>/dev/null || true
    
    printf "%b\n" "${GREEN}✓ Mise completado (algunas herramientas pueden haberse omitido)${NC}"
else
    printf "%b\n" "${YELLOW}⚠ No se encontró config de mise en $CONFIG_FILE${NC}"
fi
{{ end -}}
