#!/bin/bash
set -e

# Colores para output
if [ -t 1 ] && [ -n "$TERM" ] && [ "$TERM" != "dumb" ]; then
    BLUE='\033[0;34m'
    GREEN='\033[0;32m'
    NC='\033[0m'
else
    BLUE=''
    GREEN=''
    NC=''
fi

# Get the local hostname
HOSTNAME=$(scutil --get LocalHostName)

# Check if Nix is already installed
if ! command -v nix >/dev/null 2>&1; then
    printf "%b\n" "${BLUE}Instalando Nix...${NC}"
    sh <(curl --proto '=https' --tlsv1.2 -L https://nixos.org/nix/install)
    printf "%b\n" "${GREEN}✓ Nix instalado${NC}"
else
    printf "%b\n" "${GREEN}✓ Nix ya está instalado${NC}"
fi

# Check if nix-darwin is installed
if ! command -v darwin-rebuild >/dev/null 2>&1; then
    printf "%b\n" "${BLUE}Instalando nix-darwin...${NC}"

    # Initialize nix-darwin template in ~/.config/nix if flake.nix doesn't exist
    if [ ! -f "$HOME/.config/nix/flake.nix" ]; then
        printf "%b\n" "${BLUE}Inicializando template de nix-darwin...${NC}"
        mkdir -p "$HOME/.config/nix"
        cd "$HOME/.config/nix"
        sudo nix flake init -t nix-darwin/master
        
        # Update hostname in flake.nix
        sed -i '' "s/simple/$HOSTNAME/" flake.nix
    fi

    # Install nix-darwin from your flake in ~/.config/nix
    sudo nix run nix-darwin --extra-experimental-features "nix-command flakes" -- switch --flake ~/.config/nix#$HOSTNAME

    printf "%b\n" "${GREEN}✓ nix-darwin instalado${NC}"
else
    printf "%b\n" "${GREEN}✓ nix-darwin ya está instalado${NC}"
    
    # Apply the Nix Darwin configuration
    printf "%b\n" "${BLUE}Aplicando configuración de Nix Darwin...${NC}"
    sudo darwin-rebuild switch --flake ~/.config/nix#$HOSTNAME
fi

printf "%b\n" "${GREEN}✓ Configuración de Nix aplicada${NC}"
