#!{{ lookPath "sh" }}

{{ if eq .chezmoi.os "darwin" -}}
# Install pam-reattach if not already installed
if ! brew list pam-reattach &>/dev/null; then
  echo "Installing pam-reattach..."
  brew install pam-reattach
fi

# Configure TouchID for sudo with pam-reattach
if ! grep -q "pam_reattach.so" /etc/pam.d/sudo; then
  echo "Configuring TouchID for sudo with pam-reattach..."
  echo "auth       optional       /opt/homebrew/lib/pam/pam_reattach.so" | cat - /etc/pam.d/sudo | sudo tee /etc/pam.d/sudo.new > /dev/null
  sudo mv /etc/pam.d/sudo.new /etc/pam.d/sudo
fi

if ! grep -q "pam_tid.so" /etc/pam.d/sudo; then
  echo "auth       sufficient     pam_tid.so" | cat - /etc/pam.d/sudo | sudo tee /etc/pam.d/sudo.new > /dev/null
  sudo mv /etc/pam.d/sudo.new /etc/pam.d/sudo
fi
{{ end -}}