#!{{ lookPath "sh" }}

{{ if eq .chezmoi.os "darwin" -}}
set -e

# A√±adir Homebrew al PATH
export PATH=/opt/homebrew/bin:$PATH

# Colores para output
if [ -t 1 ] && [ -n "$TERM" ] && [ "$TERM" != "dumb" ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

# Funci√≥n para logging con colores
log_info() {
    printf "%b\n" "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    printf "%b\n" "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    printf "%b\n" "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    printf "%b\n" "${RED}‚ùå $1${NC}"
}

log_step() {
    printf "\n%b\n" "${BLUE}üöÄ $1${NC}"
}

# Verificar que estamos en macOS
if [ "$(uname -s)" != "Darwin" ]; then
    log_error "Este script solo funciona en macOS"
    exit 1
fi

# Funci√≥n para configuraci√≥n final
final_setup() {
    log_step "Configuraci√≥n final..."

    # Configurar Git para usar gh como helper de credenciales
    if command -v gh >/dev/null 2>&1; then
        log_info "Configurando Git para usar GitHub CLI como helper de credenciales..."
        git config --global --unset-all credential.https://github.com.helper >/dev/null 2>&1 || true
        git config --global --unset-all credential.https://gist.github.com.helper >/dev/null 2>&1 || true
        git config --global credential.https://github.com.helper "!$(which gh) auth git-credential"
        git config --global credential.https://gist.github.com.helper "!$(which gh) auth git-credential"
        log_success "Git configurado para usar GitHub CLI"
    else
        log_warning "GitHub CLI (gh) no encontrado, saltando configuraci√≥n de credenciales"
    fi

    # Cambiar shell por defecto a zsh si no lo es ya
    if [ "$SHELL" != "/bin/zsh" ] && [ "$SHELL" != "/usr/bin/zsh" ] && [ "$SHELL" != "/opt/homebrew/bin/zsh" ]; then
        if command -v zsh >/dev/null 2>&1;
        then
            log_info "Cambiando shell por defecto a zsh..."
            chsh -s "$(which zsh)"
            log_success "Shell cambiado a zsh"
        else
            log_warning "zsh no est√° disponible, manteniendo shell actual"
        fi
    else
        log_success "zsh ya es el shell por defecto"
    fi

    # Activar servicio borders si no est√° ya activado
    if command -v brew >/dev/null 2>&1; then
        log_info "Verificando estado del servicio borders..."
        if brew services list | grep "^borders" | grep -q "started"; then
            log_info "Servicio borders ya est√° activado"
        else
            log_info "Activando servicio borders..."
            brew services start borders
            log_success "Servicio borders activado"
        fi
    else
        log_warning "Homebrew no encontrado, no se puede activar borders"
    fi
}

# Funci√≥n para mostrar resumen final
show_summary() {
    log_step "üéâ ¬°Aplicaci√≥n de dotfiles completada!"
    
    printf "\n%b\n" "${GREEN}‚úÖ Chezmoi aplic√≥ exitosamente tus dotfiles${NC}"
    printf "\n%b\n" "${BLUE}üìã Archivos aplicados:${NC}"
    echo "  ‚Ä¢ Todos los archivos de configuraci√≥n en tu directorio home"
    echo "  ‚Ä¢ Scripts de instalaci√≥n ejecutados"
    
    printf "\n%b\n" "${YELLOW}üí° Comandos √∫tiles:${NC}"
    echo "  ‚Ä¢ chezmoi apply - Aplicar cambios nuevamente"
    echo "  ‚Ä¢ chezmoi status - Ver estado de archivos"
    echo "  ‚Ä¢ chezmoi edit ~/.file - Editar archivos gestionados"
    
    printf "\n%b\n\n" "${GREEN}üöÄ ¬°Tu configuraci√≥n est√° lista!${NC}"
}

# Funci√≥n principal
main() {
    log_step "üçé Iniciando configuraci√≥n final y resumen"
    
    # Verificar que no se ejecute como root
    if [ "$EUID" -eq 0 ]; then
        log_warning "No ejecutes este script como root."
    fi
    
    # Configuraci√≥n final
    final_setup
    
    # Mostrar resumen
    show_summary
}

# Ejecutar funci√≥n principal
main "$@"
{{ end -}}
