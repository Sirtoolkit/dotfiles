#!{{ lookPath "bash" }}

# Script para instalar Android Platform Tools
# Se ejecuta una sola vez con chezmoi
{{ if eq .chezmoi.os "darwin" -}}

set -e  # Salir si hay error

echo "üîç Verificando instalaci√≥n de Android Platform Tools..."

# Configurar ANDROID_HOME
export ANDROID_HOME="/opt/homebrew/share/android-commandlinetools"
export ANDROID_AVD_HOME="$HOME/.config/.android/avd"
export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"

echo "üìÇ Usando ANDROID_HOME: $ANDROID_HOME"

# Verificar que sdkmanager est√© disponible
if ! command -v sdkmanager &> /dev/null; then
    echo "‚ùå Error: sdkmanager no est√° disponible"
    echo "   Aseg√∫rate de que android-commandlinetools est√© instalado con Homebrew/Nix"
    exit 1
fi

echo "üìç sdkmanager encontrado en: $(which sdkmanager)"

# Aceptar licencias autom√°ticamente
echo "üìú Aceptando licencias de Android SDK..."
yes | sdkmanager --licenses > /dev/null 2>&1 || true

# Instalar platform-tools si no existe
if [ ! -d "$ANDROID_HOME/platform-tools" ] || [ ! -f "$ANDROID_HOME/platform-tools/adb" ]; then
    echo "‚¨áÔ∏è  Instalando Android Platform Tools..."
    sdkmanager "platform-tools"
    
    if [ -f "$ANDROID_HOME/platform-tools/adb" ]; then
        echo "‚úÖ Android Platform Tools instaladas correctamente"
    else
        echo "‚ùå Error: No se pudo instalar Android Platform Tools"
        exit 1
    fi
else
    echo "‚úÖ Android Platform Tools ya est√°n instaladas"
fi

# Obtener la √∫ltima versi√≥n de build-tools disponible
echo "üîç Buscando √∫ltima versi√≥n de Android Build Tools..."
LATEST_BUILD_TOOLS=$(sdkmanager --list 2>/dev/null | grep "build-tools;" | grep -v "rc" | head -1 | awk '{print $1}')

if [ -z "$LATEST_BUILD_TOOLS" ]; then
    echo "‚ö†Ô∏è  No se pudo detectar la √∫ltima versi√≥n de build-tools, usando 35.0.0"
    LATEST_BUILD_TOOLS="build-tools;35.0.0"
fi

# Instalar build-tools si no existe
if [ ! -d "$ANDROID_HOME/build-tools" ]; then
    echo "‚¨áÔ∏è  Instalando Android Build Tools ($LATEST_BUILD_TOOLS)..."
    sdkmanager "$LATEST_BUILD_TOOLS"
    echo "‚úÖ Android Build Tools instaladas correctamente"
else
    echo "‚úÖ Android Build Tools ya est√°n instaladas"
fi

echo ""
echo "üìç Herramientas instaladas en: $ANDROID_HOME"
echo "   - ADB: $ANDROID_HOME/platform-tools/adb"
echo "üí° Reinicia tu terminal para que las herramientas est√©n disponibles en el PATH"

{{ end -}}
