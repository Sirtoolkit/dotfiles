#!/bin/bash
# Desencriptar archivos Age en private_Library

set -e

BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Verificar si Age estÃ¡ instalado
if ! command -v age >/dev/null 2>&1; then
    printf "%b\n" "${YELLOW}âš  Age no instalado, saltando desencriptaciÃ³n${NC}"
    exit 0
fi

# Verificar si tenemos las claves Age
if [ ! -f ~/.config/age/keys.txt ]; then
    printf "%b\n" "${YELLOW}âš  Claves Age no encontradas en ~/.config/age/keys.txt${NC}"
    exit 0
fi

KEYS_FILE=~/.config/age/keys.txt
SECRETS_DIR="{{ .chezmoi.sourceDir }}/private_Library/private_Application Support/Leader Key"
DEST_DIR="$HOME/Library/Application Support/Leader Key"

mkdir -p "$DEST_DIR"

printf "%b\n" "${BLUE}ðŸ” Desencriptando archivos Age...${NC}"

# Buscar archivos .encrypted o .age y desencriptarlos
find "$SECRETS_DIR" -maxdepth 1 \( -name "*.encrypted" -o -name "*.age" \) 2>/dev/null | while read -r encrypted_file; do
    
    # Extraer nombre sin extensiÃ³n
    filename=$(basename "$encrypted_file" | sed 's/\(.encrypted\|\.age\)$//')
    dest_file="$DEST_DIR/$filename"
    
    printf "%b\n" "${BLUE}â†’${NC} Desencriptando $filename..."
    
    if age -d -i "$KEYS_FILE" "$encrypted_file" > "$dest_file" 2>/dev/null; then
        chmod 600 "$dest_file"
        printf "%b\n" "${GREEN}âœ“${NC} $filename desencriptado"
    else
        printf "%b\n" "${YELLOW}âš ${NC} Error desencriptando $filename${NC}"
    fi
done

printf "%b\n" "${GREEN}âœ“ DesencriptaciÃ³n completada${NC}"
