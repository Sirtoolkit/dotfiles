#!{{ lookPath "sh" }}

# Colores para output
if [ -t 1 ] && [ -n "$TERM" ] && [ "$TERM" != "dumb" ]; then
    BLUE='\033[0;34m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    RED='\033[0;31m'
    NC='\033[0m'
else
    BLUE=''
    GREEN=''
    YELLOW=''
    RED=''
    NC=''
fi

# Configurar PNPM_HOME
if [ -z "$PNPM_HOME" ]; then
  export PNPM_HOME="$HOME/Library/pnpm"
fi

if [[ ":$PATH:" != *":$PNPM_HOME:"* ]]; then
  export PATH="$PNPM_HOME:$PATH"
fi

mkdir -p "$PNPM_HOME"

# Instalar pake-cli
if ! command -v pake >/dev/null 2>&1; then
  printf "%b\n" "${BLUE}Instalando pake-cli...${NC}"
  pnpm install -g pake-cli
  export PATH="$PNPM_HOME:$PATH"
else
  printf "%b\n" "${GREEN}✓ pake-cli ya está instalado${NC}"
fi

# Verificar pake
if ! command -v pake >/dev/null 2>&1; then
  printf "%b\n" "${RED}✗ Error: pake no disponible después de instalar${NC}"
  printf "%b\n" "${YELLOW}  Ejecuta 'pnpm setup' manualmente${NC}"
  exit 1
fi

# Instalar YouTube Music
if [ ! -d "/Applications/Youtube Music.app" ]; then
  printf "%b\n" "${BLUE}Creando app de YouTube Music...${NC}"
  pake https://music.youtube.com --name 'Youtube Music'
fi

# Instalar Gemini
if [ ! -d "/Applications/Gemini.app" ]; then
  printf "%b\n" "${BLUE}Creando app de Gemini...${NC}"
  pake https://gemini.google.com --name 'Gemini'
fi

# Mover apps a /Applications
if [ -d "$HOME/Youtube Music.app" ]; then
  mv "$HOME/Youtube Music.app" /Applications/
  printf "%b\n" "${GREEN}✓ YouTube Music instalada${NC}"
fi

if [ -d "$HOME/Gemini.app" ]; then
  mv "$HOME/Gemini.app" /Applications/
  printf "%b\n" "${GREEN}✓ Gemini instalada${NC}"
fi

# Limpiar archivos .dmg
rm -f "$HOME/Youtube Music.dmg"
rm -f "$HOME/Gemini.dmg"

printf "%b\n" "${GREEN}✓ Web apps configuradas${NC}"
