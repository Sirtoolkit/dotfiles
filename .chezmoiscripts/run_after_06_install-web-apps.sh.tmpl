#!{{ lookPath "sh" }}

# Configurar PNPM_HOME si no existe
if [ -z "$PNPM_HOME" ]; then
  export PNPM_HOME="$HOME/Library/pnpm"
fi

# Asegurar que PNPM_HOME está en el PATH
if [[ ":$PATH:" != *":$PNPM_HOME:"* ]]; then
  export PATH="$PNPM_HOME:$PATH"
fi

# Crear directorio si no existe
mkdir -p "$PNPM_HOME"

if ! command -v pake >/dev/null 2>&1; then
  echo "Instalando pake-cli..."
  pnpm install -g pake-cli
  # Recargar el PATH después de la instalación
  export PATH="$PNPM_HOME:$PATH"
else
  echo "pake-cli ya está instalado. Saltando instalación."
fi

# Verificar que pake esté disponible
if ! command -v pake >/dev/null 2>&1; then
  echo "Error: pake no se encuentra después de la instalación."
  echo "Por favor, ejecuta 'pnpm setup' manualmente y vuelve a intentar."
  exit 1
fi

if [ ! -d "/Applications/Youtube Music.app" ]; then
  pake https://music.youtube.com --name 'Youtube Music'
fi

if [ ! -d "/Applications/Gemini.app" ]; then
  pake https://gemini.google.com --name 'Gemini'
fi

# Instalar las apps en /Applications
if [ -d "$HOME/Youtube Music.app" ]; then
  mv "$HOME/Youtube Music.app" /Applications/
  echo "Instalada Youtube Music en /Applications"
fi

if [ -d "$HOME/Gemini.app" ]; then
  mv "$HOME/Gemini.app" /Applications/
  echo "Instalada Gemini en /Applications"
fi

# Eliminar archivos .dmg generados
rm -f "$HOME/Youtube Music.dmg"
rm -f "$HOME/Gemini.dmg"
