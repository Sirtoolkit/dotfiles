#!/usr/bin/env bash

set -e

DRIVER_VERSION="6.0.0"
PKG_NAME="Karabiner-DriverKit-VirtualHIDDevice-${DRIVER_VERSION}.pkg"
DOWNLOAD_URL="https://github.com/pqrs-org/Karabiner-DriverKit-VirtualHIDDevice/releases/download/v${DRIVER_VERSION}/${PKG_NAME}"
TEMP_DIR=$(mktemp -d)

echo "Installing Karabiner-DriverKit-VirtualHIDDevice..."

# Check if already installed
if systemextensionsctl list | grep -q "org.pqrs.Karabiner-DriverKit-VirtualHIDDevice.*activated enabled"; then
    echo "Karabiner-DriverKit is already installed and activated."
    exit 0
fi

# Download the package
echo "Downloading ${PKG_NAME}..."
curl -L -o "${TEMP_DIR}/${PKG_NAME}" "${DOWNLOAD_URL}"

# Install the package
echo "Installing package..."
sudo installer -pkg "${TEMP_DIR}/${PKG_NAME}" -target /

# Clean up
rm -rf "${TEMP_DIR}"

# Activate the driver
echo "Activating driver..."
if [ -f "/Applications/.Karabiner-VirtualHIDDevice-Manager.app/Contents/MacOS/Karabiner-VirtualHIDDevice-Manager" ]; then
    /Applications/.Karabiner-VirtualHIDDevice-Manager.app/Contents/MacOS/Karabiner-VirtualHIDDevice-Manager activate
else
    echo "Warning: Manager app not found. Driver may need manual activation."
fi

echo ""
echo "================================================"
echo "Karabiner-DriverKit installed successfully!"
echo ""
echo "IMPORTANT: You need to grant permissions:"
echo "1. Open System Settings â†’ Privacy & Security"
echo "2. Look for 'Login Items & Extensions' or similar prompt"
echo "3. Enable the Karabiner-DriverKit extension"
echo ""
echo "Verify installation with:"
echo "  systemextensionsctl list | grep Karabiner"
echo "================================================"
