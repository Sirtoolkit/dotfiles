#!/bin/bash
#
# Este script se ejecuta con 'chezmoi apply' para poblar
# configuraciones y secretos usando las CLIs de las herramientas.

# Termina el script inmediatamente si un comando falla
set -e

# --- 1. VerificaciÃ³n de comandos ---
echo "ðŸ”Ž Verificando herramientas necesarias..."
if ! command -v dcli &> /dev/null
then
    echo "Error: Dashlane CLI 'dcli' no encontrada. Saliendo."
    exit 1
fi

if ! command -v oco &> /dev/null
then
    echo "Error: 'oco' no encontrado. Saliendo."
    echo "AsegÃºrate de que estÃ© instalado antes de ejecutar chezmoi apply."
    exit 1
fi

echo "ðŸ” Poblando secretos y configuraciones..."

# --- 2. ConfiguraciÃ³n de OpenCommits ---
echo "   -> Configurando OpenCommits (API Key y modelo)..."
# Obtenemos el secreto de Dashlane
OPEN_COMMITS_KEY=$(dcli read "dl://open-ai-api-key/content")

# Usamos el comando de la herramienta para establecer la clave
oco config set OCO_API_KEY="$OPEN_COMMITS_KEY"
oco config set OCO_EMOJI=true


echo "âœ… Configuraciones aplicadas correctamente."
